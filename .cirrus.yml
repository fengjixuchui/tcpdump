env:
  CIRRUS_CLONE_DEPTH: 3 # The internal git client reads CIRRUS_CLONE_DEPTH.
  LIBPCAP_GIT: https://github.com/the-tcpdump-group/libpcap.git

freebsd_task:
  name: FBSD
  freebsd_instance:
    cpu: 4 # allows two concurrent FreeBSD tasks
    matrix:
      - image_family: freebsd-11-4
      - image_family: freebsd-12-2
      - image_family: freebsd-13-0-snap
  env:
    IGNORE_OSVERSION: yes
    MAKEFLAGS: -j 4
  script:
    - freebsd-version
    - pkg install -qy git autoconf
    - (cd .. && git clone --depth ${CIRRUS_CLONE_DEPTH} --branch=master --quiet ${LIBPCAP_GIT} && cd libpcap && ./configure --prefix=/tmp && make -s)
    - touch .devel
    - ./configure --prefix=/tmp
    - make -s CFLAGS=-Werror all
    - make check
    - make install
    - make releasetar

linux_task:
  name: LNX+BM
  container:
    cpu: 8 # allows one concurrent Linux task
    image: ubuntu:20.04
  env:
    DEBIAN_FRONTEND: noninteractive
    MAKEFLAGS: -j 8
  script:
    - apt-get -qy update
    - apt-get -qy install git autoconf make cmake clang gcc
    - apt-get -qy install flex bison libdbus-1-dev libbluetooth-dev libnl-genl-3-dev libibverbs-dev # for libpcap
    - apt-get -qy install libssl-dev libsmi2-dev libcap-ng-dev libpcap-dev
    - apt list --installed 'lib*-dev'
    - (cd .. && echo '$ git clone [...] libpcap.git' && git clone --depth ${CIRRUS_CLONE_DEPTH} --branch=master --quiet ${LIBPCAP_GIT})
    - ./build_matrix.sh

macos_task:
  name: MAC+BM
  macos_instance:
    image: big-sur-xcode
  env:
    MAKEFLAGS: '-j 12' # macOS VMs always run on 12 cores
    MATRIX_CC: clang # GCC is a symlink to Clang in macOS
  script:
    - brew update >/dev/null
    - brew install libsmi | grep -v '%'
    - (cd .. && echo '$ git clone [...] libpcap.git' && git clone --depth ${CIRRUS_CLONE_DEPTH} --branch=master --quiet ${LIBPCAP_GIT})
    - ./build_matrix.sh
